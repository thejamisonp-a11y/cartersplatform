<!-- Floating Action Button -->
<div class="fixed bottom-6 right-6 z-50">
  <button (click)="toggleChat()" class="bg-primary hover:bg-mint text-white rounded-full p-4 shadow-lg transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
    @if (isOpen()) {
      <i data-lucide="x" class="w-8 h-8"></i>
    } @else {
      <i data-lucide="message-circle-question" class="w-8 h-8"></i>
    }
  </button>
</div>

<!-- Chat Window -->
<div class="fixed bottom-24 right-6 w-[90vw] max-w-md h-[70vh] max-h-[600px] bg-base-100 rounded-2xl shadow-2xl flex flex-col z-40 transition-all duration-300 ease-in-out origin-bottom-right"
  [class]="isOpen() ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-5 scale-95 pointer-events-none'">
    
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b bg-base-200 rounded-t-2xl shrink-0">
      <div class="flex items-center gap-3">
        <div class="bg-primary/20 p-2 rounded-full">
            <i data-lucide="bot" class="w-6 h-6 text-primary"></i>
        </div>
        <div>
            <h3 class="font-bold text-lg text-content">Carter AI</h3>
            <p class="text-xs text-green-500 font-semibold">‚óè Online</p>
        </div>
      </div>
      <button (click)="toggleHelp()" class="p-2 text-content-secondary hover:text-primary rounded-full hover:bg-primary/10">
        <i data-lucide="help-circle" class="w-6 h-6"></i>
      </button>
    </div>

    <!-- Main Content: Chat or Help -->
    <div #chatContainer class="flex-1 overflow-y-auto relative">
      @if (showHelp()) {
        <!-- Help Section -->
        <div class="p-6 text-content">
          <h4 class="font-bold text-lg mb-4">How to talk to Carter</h4>
          <p class="text-sm text-content-secondary mb-4">
            Carter can help you find information, summarize data, and understand protocols on the Carters Care Platform. For the best results, ask clear and specific questions.
          </p>
          <h5 class="font-semibold text-md mb-3">Example Prompts:</h5>
          <div class="space-y-3 text-sm">
            <div class="bg-base-200 p-3 rounded-lg">"What is the protocol for a medium-severity incident?"</div>
            <div class="bg-base-200 p-3 rounded-lg">"Summarize Eleanor Vance's progress in the last month."</div>
            <div class="bg-base-200 p-3 rounded-lg">"Find compliance documents expiring in the next 30 days."</div>
            <div class="bg-base-200 p-3 rounded-lg">"What are the key components of a community access care plan?"</div>
          </div>
          <button (click)="toggleHelp()" class="mt-6 w-full bg-primary text-white py-2 rounded-lg font-semibold hover:bg-primary/90">Got it!</button>
        </div>
      } @else {
        <!-- Chat History -->
        <div class="p-4 space-y-4">
          @for (message of messages(); track $index) {
            <div class="flex" [class]="message.sender === 'user' ? 'justify-end' : 'justify-start'">
              <div class="max-w-[80%] p-3 rounded-2xl" [class]="message.sender === 'user' ? 'bg-primary text-white rounded-br-none' : 'bg-base-200 text-content rounded-bl-none'">
                <p class="text-sm">{{ message.text }}</p>
              </div>
            </div>
          }
          @if (isThinking()) {
            <div class="flex justify-start">
              <div class="max-w-[80%] p-3 rounded-2xl bg-base-200 text-content rounded-bl-none flex items-center gap-2">
                <span class="w-2 h-2 bg-primary rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                <span class="w-2 h-2 bg-primary rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                <span class="w-2 h-2 bg-primary rounded-full animate-bounce"></span>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Input Form -->
    <div class="p-4 border-t bg-base-100 rounded-b-2xl shrink-0" [class]="showHelp() ? 'hidden' : ''">
      <div class="flex items-center gap-2">
        <input #promptInput (keydown.enter)="sendMessage(promptInput)" type="text" placeholder="Ask Carter anything..." class="w-full px-4 py-2 bg-base-200 rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm">
        <button (click)="sendMessage(promptInput)" class="bg-primary text-white rounded-full p-2.5 hover:bg-mint transition-colors">
          <i data-lucide="send" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
</div>
